<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear transport (FEM-SUPG) · BcubeTutorials</title><meta name="title" content="Linear transport (FEM-SUPG) · BcubeTutorials"/><meta property="og:title" content="Linear transport (FEM-SUPG) · BcubeTutorials"/><meta property="twitter:title" content="Linear transport (FEM-SUPG) · BcubeTutorials"/><meta name="description" content="Documentation for BcubeTutorials."/><meta property="og:description" content="Documentation for BcubeTutorials."/><meta property="twitter:description" content="Documentation for BcubeTutorials."/><meta property="og:url" content="https://bcube-project.github.io/BcubeTutorials.jl/example/transport_supg/"/><meta property="twitter:url" content="https://bcube-project.github.io/BcubeTutorials.jl/example/transport_supg/"/><link rel="canonical" href="https://bcube-project.github.io/BcubeTutorials.jl/example/transport_supg/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.jpg" alt="BcubeTutorials logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">BcubeTutorials</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorial/helmholtz/">Helmholtz equation (FE)</a></li><li><a class="tocitem" href="../../tutorial/heat_equation/">Heat equation (FE)</a></li><li><a class="tocitem" href="../../tutorial/linear_transport/">Linear transport (DG)</a></li><li><a class="tocitem" href="../../tutorial/phase_field_supercooled/">Phase field model - solidification of a liquid in supercooled state</a></li></ul></li><li><span class="tocitem">Advanced examples</span><ul><li><a class="tocitem" href="../covo/">Euler equations - covo</a></li><li><a class="tocitem" href="../euler_naca_steady/">Euler equations on a NACA0012</a></li><li><a class="tocitem" href="../linear_elasticity/">Linear elasticity</a></li><li><a class="tocitem" href="../linear_thermoelasticity/">Thermo-elasticity</a></li><li><a class="tocitem" href="../constrained_poisson/">Constrained Poisson equation (FE)</a></li><li class="is-active"><a class="tocitem" href>Linear transport (FEM-SUPG)</a><ul class="internal"><li><a class="tocitem" href="#Maths"><span>Maths</span></a></li><li><a class="tocitem" href="#Code"><span>Code</span></a></li></ul></li><li><a class="tocitem" href="../poisson_dg/">Poisson equation (DG)</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Advanced examples</a></li><li class="is-active"><a href>Linear transport (FEM-SUPG)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear transport (FEM-SUPG)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/bcube-project/BcubeTutorials.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/bcube-project/BcubeTutorials.jl/blob/main/docs/src/example/transport_supg.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Linear-transport-(FEM-SUPG)"><a class="docs-heading-anchor" href="#Linear-transport-(FEM-SUPG)">Linear transport (FEM-SUPG)</a><a id="Linear-transport-(FEM-SUPG)-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-transport-(FEM-SUPG)" title="Permalink"></a></h1><p>This example demonstrates the application of the FEM Streamline Upwind Petrov-Galerkin method to a linear transport equation.</p><h2 id="Maths"><a class="docs-heading-anchor" href="#Maths">Maths</a><a id="Maths-1"></a><a class="docs-heading-anchor-permalink" href="#Maths" title="Permalink"></a></h2><p>There are several ways to present the method, here is one adapted from the <a href="https://doi.org/10.1016/C2009-0-26328-8">book</a> of Zienkiwicz <em>et al.</em> (The Finite Element Method for Fluid Dynamics).</p><p>We consider the following transport equation:</p><p class="math-container">\[\begin{aligned}
  \partial_t u + c \cdot \nabla u = 0 \\
  u(0, t) = u_{in}(t)
\end{aligned}\]</p><p>where <span>$c$</span> is the transport velocity. To ease the demonstration, we restrict ourselves to a 1D equation at a constant velocity : <span>$\partial_t u + c \partial_x u = 0$</span>. Let&#39;s introduce <span>$\chi(t)$</span> a (characteristic) curve corresponding to this equation, then</p><p class="math-container">\[\dfrac{du}{dt} = \dfrac{\partial \chi}{\partial t} \dfrac{\partial u}{\partial x} + \dfrac{\partial u}{\partial t}\]</p><p>so that with <span>$\partial \chi / \partial t = c$</span> we have that <span>$du/dt$</span> is zero along the characteristic curve. Let&#39;s note <span>$u^n(x)$</span> the solution at point <span>$x$</span> and time <span>$n \Delta t$</span>. Let&#39;s also note <span>$\delta = c \Delta t$</span> and apply a first order Taylor expansion in time for <span>$du/dt$</span>:</p><p class="math-container">\[\dfrac{1}{\Delta t}(u^{n+1}(x) - u^n(x - \delta)) = 0\]</p><p>The <span>$x - \delta$</span> comes from the fact that we are differentiating along the characteristic curve. Then, a Taylor expansion in space of <span>$u^n(x - \delta)$</span> leads to</p><p class="math-container">\[u^n(x - \delta) = u^n(x) - \delta \partial_x u^n + \dfrac{\delta^2}{2} \partial^2_x u^n\]</p><p>The time-space discretization now reads</p><p class="math-container">\[u^{n+1} = u^n - \delta \partial_x u^n + \dfrac{\delta^2}{2} \partial^2_x u^n\]</p><p>To compute the weak form, we multiply by a test function <span>$v$</span> and integrate over the whole domain. An integration by parts is performed on the last term, ignoring boundary terms for this specific example.</p><p class="math-container">\[\begin{aligned}
  &amp; \int_\Omega u^{n+1} v = \int_\Omega u^n v - \int_\Omega \delta (\partial_x u^n)v + \int_\Omega \dfrac{\delta^2}{2} (\partial^2_x u^n) v \\
  &amp; \int_\Omega u^{n+1} v = \int_\Omega u^n v - \int_\Omega \delta (\partial_x u^n)v - \int_\Omega \dfrac{\delta^2}{2} \partial_x u^n \partial_x v \\
  &amp; \int_\Omega u^{n+1} v = \int_\Omega u^n v - \int_\Omega \delta (\partial_x u^n) \left(v +\dfrac{\delta}{2} \partial_x v \right) \\
\end{aligned}\]</p><p>Hence, the weak formulation is quite straigthforward, it simply consists in replacing the test function <span>$v$</span> in the advection term by <span>$v + c\Delta t \partial_x v / 2$</span>.</p><h2 id="Code"><a class="docs-heading-anchor" href="#Code">Code</a><a id="Code-1"></a><a class="docs-heading-anchor-permalink" href="#Code" title="Permalink"></a></h2><pre><code class="language-julia hljs">using Bcube
using LinearAlgebra
using StaticArrays
using Plots

const degree = 1 # Function-space degree (Taylor(0) = first order Finite Volume)
const nite = 250 # Number of time iteration(s)
const CFL = 0.5 # CFL number
const nx = 101 # Number of nodes in the x-direction
const ny = 41 # Number of nodes in the y-direction
const lx = 1.0 # Domain width
const ly = 2.0 # Domain height
const c = SA[1.0] # Transport velocity

@assert degree &gt;= 1 &quot;Cannot apply Dirichlet when degree = 0!&quot;</code></pre><p>Build mesh, and prepare output</p><pre><code class="language-julia hljs">mesh = line_mesh(nx; xmax = lx, names = (&quot;West&quot;, &quot;East&quot;))

out_dir = joinpath(@__DIR__, &quot;../../../myout/linear_transport&quot;)
mkpath(out_dir)</code></pre><p>Time step defined by a CFL condition</p><pre><code class="language-julia hljs">const Δt = CFL * min(lx / (nx - 1), ly / (ny - 1)) / norm(c)
t = 0.0</code></pre><p>Inlet boundary condition. Use <code>f_west(x, t) = 1.0</code> for a square.</p><pre><code class="language-julia hljs">f_west(x, t) = sin(10 * t) # better start with 0 at t=0</code></pre><p>Function space, trial and test FESpace, with the boundary condition</p><pre><code class="language-julia hljs">fs = FunctionSpace(:Lagrange, degree)
U = TrialFESpace(fs, mesh, Dict(&quot;West&quot; =&gt; f_west))
V = TestFESpace(U)</code></pre><p>Measure for domain discretization</p><pre><code class="language-julia hljs">dΩ = Measure(CellDomain(mesh), 2 * degree + 1)</code></pre><p>Compute &#39;h&#39;, the cell characteristic length</p><pre><code class="language-julia hljs">vol = MeshCellData(Bcube.compute(∫(PhysicalFunction(x -&gt; 1))dΩ))</code></pre><p>SUPG test function : two equivalent formulae: $ \tilde{v} = v + \dfrac{\Delta t}{2} c \cdot \nabla v$ or $ \tilde{v} = v + \alpha \dfrac{\Delta x}{2} \dfrac{c}{|c|} \cdot \nabla v$ where <span>$\alpha = c \Delta t / \Delta x$</span> is the CFL number.</p><pre><code class="language-julia hljs">supg(v) = v + Δt / 2 * c ⋅ ∇(v)
# supg(v) = v + CFL * h / (2 * norm(c)) * (c ⋅ ∇(v))</code></pre><p>Bilinear forms (mass and advection) definitions and assembly</p><pre><code class="language-julia hljs">a(u, v) = ∫(u ⋅ v)dΩ # Mass bilinear form : no supg
b(u, v) = ∫((c ⋅ ∇(u)) ⋅ supg(v))dΩ # Convection bilinear form

A = assemble_bilinear(a, U, V)
B = assemble_bilinear(b, U, V)
M = I - Δt * inv(Matrix(A)) * B #WARNING : really expensive !!!</code></pre><p>Build FE functions : one for the computed solution, one for the reference solution interpolated on the FESpace (that the best we can obtain!)</p><pre><code class="language-julia hljs">u = FEFunction(U)
apply_dirichlet_to_vector!(u.dofValues, U, V, mesh, t)

u_ref = FEFunction(U)</code></pre><p>Prepare animation. Since the mesh and the FESpace are &quot;trivial&quot;, we directly extract the mesh coordinates into a vector and the dof values are in the same order.</p><pre><code class="language-julia hljs">anim = Animation()
x = [coords(node, 1) for node in get_nodes(mesh)]</code></pre><p>Let&#39;s loop</p><pre><code class="language-julia hljs">for i in 1:nite
    global t

    # Update time
    t += Δt

    # Update solution
    u.dofValues .= M * u.dofValues

    # Apply bnd condition : we can also set M[1,:] = [1, 0...]
    apply_dirichlet_to_vector!(u.dofValues, U, V, mesh, t)

    # Evaluate and project reference solution on FESpace
    projection_l2!(
        u_ref,
        PhysicalFunction(x -&gt; (x[1] - c[1] * t) &gt; 0 ? 0.0 : f_west(0, t - x[1] / c[1])),
        mesh,
    )

    # Build animation
    plt = plot(x, u.dofValues; label = &quot;u&quot;, xlabel = &quot;x&quot;)
    plot!(x, u_ref.dofValues; label = &quot;u_ref&quot;, ls = :dot)
    frame(anim, plt)
end</code></pre><p>Here is the output animation</p><pre><code class="language-julia hljs">g = gif(anim, joinpath(out_dir, &quot;transport_supg.gif&quot;))
display(g)</code></pre><p><img src="../../assets/transport_supg.gif" alt/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../constrained_poisson/">« Constrained Poisson equation (FE)</a><a class="docs-footer-nextpage" href="../poisson_dg/">Poisson equation (DG) »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Sunday 7 April 2024 12:26">Sunday 7 April 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
